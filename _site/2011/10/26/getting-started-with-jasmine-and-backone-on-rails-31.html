<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
  <link rel="stylesheet" href="/stylesheets/flooose.css" type="text/css">
    <link href='http://fonts.googleapis.com/css?family=Goudy+Bookletter+1911&v1' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Droid+Sans+Mono' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>

    <link href='http://fonts.googleapis.com/css?family=Vollkorn&v1' rel='stylesheet' type='text/css'>
<html xmlns="http://www.w3.org/1999/xhtml">

    <script src='/javascripts/jquery-1.5.2.js'></script>

    <head>
        <title></title>
    </head>
    <body>
      <div id="container" class="container">
	<div id='header' class="header">
	  <h1 id="h1-page-title" class="page-title"><a href="http://flooose.github.com">flooose.github.com</a></h1>
	  <h2 id="h2-page-title" class="page-title">linux and open source</h2>
	</div>
	<div id="sidebar" class="sidebar">
	  <script charset="utf-8" src="http://widgets.twimg.com/j/2/widget.js"></script>
          <script>
          new TWTR.Widget({
            version: 2,
            type: 'profile',
            rpp: 4,
            interval: 30000,
            width: 250,
            height: 300,
            theme: {
              shell: {
                background: '#373b3b',
                color: '#efeff1'
              },
              tweets: {
                background: '#494f4f',
                color: '#efeff1',
                links: '#4aed05'
              }
            },
            features: {
              scrollbar: false,
              loop: false,
              live: false,
              behavior: 'all'
            }
          }).render().setUser('flooose').start();
          </script>
	  <ul id="posts" class="posts">
	    
	    <li><a href="/2012/03/23/from-aliases-to-functions-in-bash.html">From Aliases to Functions. An introduction to bash Functions.</a></li>
	    
	    <li><a href="/2012/02/09/get-the-js-lead_out.html">Get the (js) lead out</a></li>
	    
	    <li><a href="/2011/11/11/setting-up-jasmine-and-backbone-js-in-rails-3.1.html">Setting up Jasmine and Backbone in Rails 3.1</a></li>
	    
	    <li><a href="/2011/10/26/getting-started-with-jasmine-and-backone-on-rails-31.html">Getting Started with Jasmine and Backbone.js on Rails 3.1</a></li>
	    
	    <li><a href="/2011/02/23/screen-gnu-screen-gnu-screen-and-your-terminal.html">Hands off! An attempt at a mouseless work-flow with Gnu Screen</a></li>
	    
	  </ul>
	</div>
	<br />
	<div id="content" class="content">
          <h3><b>* <span class="caps">NOTICE</span>: This post has a been revised <a href="http://flooose.github.com/2011/11/11/setting-up-jasmine-and-backbone-js-in-rails-3.1.html">here</a> . You&#8217;d probably be better of reading it, if you want a less befuddled introduction to all of this. *</b></h3>
<h2>Getting Started with Jasmine and Backbone.js on Rails 3.1</h2>
<p>ok, it took me way too long to figure this out. Maybe this will help others who are having into difficulties getting started with the asset pipeline.</p>
<p>I wanted to get some experience with Backbone.js and thought creating a simple, throw-away Rails application would be a great place to do it.</p>
<p>Little did I know how hard it would be to do just that.</p>
<p>There are lots of tutorials out there about Rails (of course), Backbone and Jasmine, but none of them seemed to help me in this particular constellation:</p>
<p>Rails &gt;= 3.1 (i.e. the asset pipeline) + Jasmine + Backbone</p>
<p>Again, there are tutorials out there, but I was running into errors about my Backbone model not being defined and about Backbone not being found. Everything was there, it just wasn&#8217;t hooked up correctly.</p>
<p>So let&#8217;s get started. I wanted a barebones app so I could really focus on the Backbone part, and how to make Javascript <span class="caps">MVC</span> work for me.</p>
<p class="code">$ rails new trashy_blog # get it? I&#8217;ll be throwing it away later, so it&#8217;s trash(y)<br />
&#8230;a bunch of familiar output<br />
$ cd trashy_blog</p>
<p>Of course, I develop test driven and I believe test writing also facilitates learning, so I added &#8220;gem &#8216;jasmine&#8217;&#8221; to my Gemfile. I wanted this to be the only additional gem in the Gemfile.</p>
<p>Keeping with this, I thought I&#8217;d be able to just add <code>backbone-min.js</code> and its dependency <code>underscore-min.js</code> to my vendor/assets/javascripts folder. That flopped and it was the first place where I ran into problems. Let&#8217;s take a closer look</p>
 <p class="code" > $ bundle install<br />
&#8230;more familiar output<br />
$ bundle exec jasmine init<br />
Jasmine has been installed with example specs.<br />
<br />
To run the server:<br />
<br />
rake jasmine<br />
<br />
To run the automated CI task with Selenium:</p>
<p>After that, I wrote my first spec. It should be noted here that a lot of this code is taken and adapted from <a href="http://tinnedfruit.com/2011/03/25/testing-backbone-apps-with-jasmine-sinon-2.html">here</a> , an excellent post covering the same material but without the asset pipeline.</p>
<p>Here&#8217;s what the spec looks like:</p>
<pre>$ cat spec/javascripts/backbone/post.spec.js
describe('Post model', function() {

    describe('when instantiated', function() {

        it('should exhibit attributes', function() {
            var post = new Post({
                title: 'Rake leaves'
            });
            expect(post.get('title'))
                .toEqual('Rake leaves');
        });

    });

});
</pre>
<p>I know that most people are using Coffeescript to do their Javascript development. I don&#8217;t have any experience with it, so I&#8217;d rather get this running and deal with switching to coffeescript when I refactor my running code.</p>
<p>Of course this test fails because we haven&#8217;t even written the code we&#8217;re testing.</p>
<p>This test should pass with one simple line in one simple file (this, incidentally, is what the rest of this post will be focused on solving.):</p>
<p class="code">$ cat app/assets/javascripts/models/post.js<br />
var Todo = Backbone.Model.extend();</p>
<p>Let&#8217;s see what Jasmine has to say about this. First let&#8217;s start the server:</p>
<p class="code">$ rake jasmine</p>
<p>This starts a test server, which has to be visited in your browser. If you&#8217;re just reading along, here&#8217;s the significant part of the output:</p>
<p class="code">ReferenceError: Post is not defined in http://localhost:8888/<i>spec</i>/backbone/post.spec.js (line 6)</p>
<p>Okay, Jasmine isn&#8217;t finding my source files.</p>
<p>I never found out how to get Jasmine to add <code>app/assets/javascripts/**/*.js</code> to the load path. I&#8217;m sure it can be done and it seems like it would be a good way to do your development. Instead of compiling my assets everytime, it would be nice if Jasmine could handle this. Whatever. I&#8217;m new at this. There&#8217;s probably a good reason not to do it.</p>
<p>Moving on, I decided to go the compiling route.</p>
<p class="code">$ rake assets:precompile</p>
<p>Back at the Jasmine test output page nothing changed. I got the same error as above.</p>
<p>At this point, my intuition felt like it hit a brick wall, so I looked at the files in <code>spec/</code>. Ahhh, <code>bundle exec jasmine init</code> created some files&#8230;imagine that! Looking at <code>spec/javascripts/support/jasmine.yml</code> seems to define where to look for files <span class="caps">AND</span> <code>public/assets/*.js</code> isn&#8217;t included.</p>
<p>Great! So I added it.</p>
<p class="code"> $ grep -A 5 -B 5 &#8216;assets&#8217; spec/javascripts/support/jasmine.yml<br />
#   &#8211; lib/source1.js<br />
#   &#8211; lib/source2.js<br />
#   &#8211; dist/<strong>/</strong>.js<br />
#<br />
src_files:<br />
  &#8211; public/assets/*.js<br />
  &#8211; public/javascripts/prototype.js<br />
  &#8211; public/javascripts/effects.js<br />
  &#8211; public/javascripts/controls.js<br />
  &#8211; public/javascripts/dragdrop.js<br />
  &#8211; public/javascripts/application.js</p>
<p>Still no dice though, the Jasmine output window still shows the same error. Up until this point, I felt that there was no need to even have the Rails models, controllers, etc. for my Post resource because I&#8217;m only testing javascript. Desperate times call for desperate measures. I ran the scaffold generator to see what the browser&#8217;s javascript console tells me.</p>
<p class="code">$ rails g scaffold Post title:string content:text<br />
&#8230;familiar output<br />
$ rake db:create db:migrate<br />
$ rails s</p>
<p>Navigating to <code>localhost:3000/posts/new</code> and looking at the javascript console&#8217;s output revealed this error <code>Backbone is not defined</code>. Hmm, I checked that the above mention javascript files were indeed in <code>vendor/assets/javascripts</code>, thinking that maybe it would make a difference if I moved them out of the <code>javascripts</code> folder and simply kept them in <code>vendor/assets/</code> proved not to work out either.</p>
<p>Desperate times call for desperate measures. I broke down and decided to use the <code>rails-backbone</code> gem:</p>
<p class="code">$ echo &#8220;gem &#8216;rails-backbone&#8217;&#8221; &gt;&gt; Gemfile<br />
$ bundle install<br />
&#8230;familiar output</p>
<p>I restarted the server, but to no avail.</p>
<p>Desperate times  call for desperate measures. What do desperate people do at this point?</p>
<p>After more head scratching, I decided to go through the Rails <a href="http://guides.rubyonrails.org/asset_pipeline.html">asset pipeline</a> guide one more time.</p>
<p>I was starting to wonder if I&#8217;d need to read up on Sprockets to get to the bottom of this when I came across <a href="http://guides.rubyonrails.org/asset_pipeline.html#manifest-files-and-directives">this</a> . It references <code>app/assets/javascripts/application.js</code> and mentions that this is where we specify which files are to be included. I added two lines to <code>application.js</code></p>
<pre>//= require underscore-min
//= require backbone-min</pre>
<p>(I think order is important here and the <a href="http://documentcloud.github.com/backbone/">Backbone site</a> mentions that Underscore JS is the only &#8220;hard dependency&#8221;). Then I gave it another try.</p>
<p><span class="caps">WTF</span>!?! No errors in the browsers javascript console; the error about <code>Backbone is not defined</code> has gone away! Let&#8217;s look at <code>http://localhost:8888</code>, our Jasmine server. That shit&#8217;s also green!</p>
<p>Ok, litmus test time. If I create an app, create a js-spec <code>spec/javascripts/backbone/somefile.spec.js</code>, add &#8216;gem jasmine&#8217; to my Gemfile, make the following changes in my app:</p>
<ol>
	<li>Add <code>underscore-min.js</code> and <code>backbone-min.js</code> to <code>vendor/assets/javascripts</code></li>
	<li>Edit <code>app/assets/javascripts/application.js</code> to include these files, repectively</li>
	<li>Edit <code>spec/javascripts/support/jasmine.yml</code> to include <code>public/assets/**/*.js</code></li>
</ol>
<p>then precompile the assets, Jasmine should be able to make my tests pass <span class="caps">AND</span> Rails should be able to load my Backbone.js files so that I can have client-side <span class="caps">MVC</span>.</p>
<p>I&#8217;m tryin&#8217; it!</p>
<p class="code">&#8230;time passes</p>
<p>It worked! I created trashy_blog2, followed the 3 steps just mentioned and it worked, without the overhead of &#8216;rails-backbone&#8217;, which isn&#8217;t actually that much overhead, I just wanted to make it work without it.</p>
<p>Nice. Badass.</p>
<p>So the lesson here is that files in <code>vendor/assets/javascript</code> have to be manually <code>require</code>d, while files in <code>app/assets/javascripts/</code> are automatically picked up.</p>
<p>It took all of this just to start working with Backbone. Don&#8217;t even ask me about Backbone.Routers and Backbone.Views. I&#8217;ll cover that and the refactoring in another post when I actually do some concrete Backbone development.</p>
	    <div id="disqus_thread">
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'flooose'; // required: replace example with your forum shortname

    // The following are highly recommended additional parameters. Remove the slashes in front to use.
    // var disqus_identifier = '/2011/10/26/getting-started-with-jasmine-and-backone-on-rails-31.html';
    // var disqus_url = '/2011/10/26/getting-started-with-jasmine-and-backone-on-rails-31.html';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
	    </div>

<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
	</div>
	<div id="footer" class="footer"></div>
      </div>
    </body>
</html>
